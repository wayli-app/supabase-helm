# Versioning and Release Process

This document explains how versioning and releases work in the Supabase Helm Chart project.

## Overview

The project uses **manual versioning** with **on-demand releases**:
- Version is manually bumped in `Chart.yaml`
- Releases are triggered manually via GitHub Actions
- Release notes are automatically generated by GitHub
- CI runs automatically on every push/PR for validation

## Semantic Versioning

We follow [Semantic Versioning 2.0.0](https://semver.org/):

```
MAJOR.MINOR.PATCH (e.g., 1.2.3)
```

### Version Components

- **MAJOR** (`X.0.0`): Incompatible API changes, breaking changes
- **MINOR** (`0.X.0`): New functionality in a backward compatible manner
- **PATCH** (`0.0.X`): Backward compatible bug fixes

### When to Bump

| Change Type | Version Bump | Examples |
|-------------|--------------|----------|
| Breaking changes | MAJOR | Remove/rename values, change defaults that break existing deployments, incompatible API changes |
| New features | MINOR | Add new service, add new configuration option, add new template |
| Bug fixes | PATCH | Fix bugs, update dependencies, improve documentation |
| Documentation | PATCH | Update README, fix typos, improve examples |
| Refactoring | PATCH | Code cleanup, template improvements (no behavior change) |

## Versioning Workflow

### For Contributors

1. **Make your changes** and create a PR
2. **CI runs automatically** to validate your changes
3. **Get your PR reviewed and merged**
4. Maintainers will handle version bumps and releases

### For Maintainers

#### Step 1: Update Chart Version

Edit [`charts/supabase/Chart.yaml`](../charts/supabase/Chart.yaml):

```yaml
apiVersion: v2
name: supabase
description: A complete Helm chart for deploying Supabase on Kubernetes
type: application
version: 0.0.9          # Update this
appVersion: 0.0.9       # Update this too
```

**Tips:**
- Update both `version` and `appVersion` to match
- Follow semantic versioning guidelines
- Check what changes were made since last release

#### Step 2: Commit Version Bump

```bash
git add charts/supabase/Chart.yaml
git commit -m "chore: bump version to 0.0.9"
git push origin main
```

#### Step 3: Trigger Release

1. Go to [GitHub Actions](https://github.com/wayli-app/supabase-helm/actions)
2. Select **"Release Pipeline"**
3. Click **"Run workflow"** dropdown
4. Optionally check **"dry-run"** to test first
5. Click **"Run workflow"** button

#### Step 4: Verify Release

After the workflow completes, verify:

- [ ] Git tag created (e.g., `v0.0.9`)
- [ ] GitHub Release published with notes
- [ ] Chart available in GHCR: `oci://ghcr.io/wayli-app/charts/supabase:0.0.9`
- [ ] Chart available in Helm repo: `https://wayli-app.github.io/supabase-helm`

## Workflow Files

### `.github/workflows/ci.yaml`

**Triggers:** Every push to main, every PR
**Purpose:** Validate changes without releasing

- Runs linting (YAML, Helm, shellcheck)
- Tests chart templating
- Validates chart structure
- Provides fast feedback

### `.github/workflows/release.yaml`

**Triggers:** Manual only (`workflow_dispatch`)
**Purpose:** Create and publish releases

- Reads version from `Chart.yaml`
- Checks if tag already exists
- Creates git tag
- Packages Helm chart
- Publishes to GitHub Pages
- Pushes to GHCR
- Generates release notes automatically

## Dry-Run Mode

Test the release process without actually publishing:

```bash
# Via GitHub Actions UI:
# 1. Go to Actions → Release Pipeline → Run workflow
# 2. Check "dry-run" checkbox
# 3. Click "Run workflow"
```

This will:
- Show what version would be released
- Show what tag would be created
- Validate all steps
- **Not** create tags, releases, or publish charts

## Release Notes

Release notes are **automatically generated** by GitHub's release notes feature. They include:

- Summary of changes since last release
- List of commits with links
- List of contributors
- Breaking changes (if marked in commits)

### Improving Release Notes

Use clear, descriptive commit messages:

**Good:**
```bash
git commit -m "feat: add support for external PostgreSQL"
git commit -m "fix: resolve Kong configuration timeout"
git commit -m "docs: add migration guide for v1.0"
```

**Bad:**
```bash
git commit -m "update stuff"
git commit -m "fixes"
git commit -m "wip"
```

## Version History

Check release history:
- [GitHub Releases](https://github.com/wayli-app/supabase-helm/releases)
- [Git Tags](https://github.com/wayli-app/supabase-helm/tags)

Install specific versions:
```bash
# From GHCR
helm install my-supabase oci://ghcr.io/wayli-app/charts/supabase --version 0.0.9

# From Helm repo
helm repo add supabase-helm https://wayli-app.github.io/supabase-helm
helm install my-supabase supabase-helm/supabase --version 0.0.9
```

## Best Practices

### 1. Batch Related Changes

Don't release after every small change. Instead:
- Collect related bug fixes → Release patch
- Collect new features → Release minor
- Plan breaking changes → Release major

### 2. Test Before Releasing

- Run tests locally: `helm lint charts/supabase`
- Use dry-run mode first
- Verify CI passes on main branch

### 3. Document Breaking Changes

For major version bumps:
- Document what breaks
- Provide migration guide
- Update examples
- Mention in release notes

### 4. Keep Chart.yaml Updated

Always update `Chart.yaml` before releasing:
- Bump `version`
- Bump `appVersion`
- Update `description` if needed
- Verify `dependencies` are correct

### 5. Monitor Release Workflow

Watch the release workflow execution:
- Check for errors
- Verify all steps complete
- Confirm chart is published
- Test installation afterwards

## Troubleshooting

### Tag Already Exists

**Error:** Tag `v0.0.9` already exists

**Solution:** Bump to next version or use a different version number

### Release Workflow Fails

**Common causes:**
- Tag already exists
- Chart packaging error
- GitHub permissions issue
- GHCR authentication failure

**Debug steps:**
1. Check workflow logs
2. Run dry-run mode
3. Verify Chart.yaml syntax
4. Check repository settings

### Chart Not Appearing

**If chart not in GHCR:**
- Check GHCR packages page
- Verify authentication
- Check workflow logs

**If chart not in Helm repo:**
- Check gh-pages branch
- Verify index.yaml updated
- Run `helm repo update`

## Migration Notes

### From Automatic to Manual Releases

This project previously used automatic releases. The new approach provides:

**Benefits:**
- Full control over release timing
- Ability to batch changes
- Test before releasing (dry-run)
- Simpler to understand
- Standard practice for Helm charts

**Changes:**
- No automatic version bumps
- No automatic releases on push
- Maintainers trigger releases manually
- Version in Chart.yaml is source of truth

## Examples

### Example 1: Bug Fix Release

```bash
# 1. Fix the bug, merge PR
# 2. Update version
vim charts/supabase/Chart.yaml  # 0.0.8 → 0.0.9

# 3. Commit
git add charts/supabase/Chart.yaml
git commit -m "chore: bump version to 0.0.9"
git push

# 4. Release via GitHub Actions UI
```

### Example 2: Feature Release

```bash
# 1. Add feature, merge PR
# 2. Update version
vim charts/supabase/Chart.yaml  # 0.0.9 → 0.1.0

# 3. Commit
git add charts/supabase/Chart.yaml
git commit -m "chore: bump version to 0.1.0"
git push

# 4. Release via GitHub Actions UI
```

### Example 3: Breaking Change Release

```bash
# 1. Make breaking changes, merge PR
# 2. Update version
vim charts/supabase/Chart.yaml  # 0.1.0 → 1.0.0

# 3. Commit with breaking change note
git add charts/supabase/Chart.yaml
git commit -m "chore: bump version to 1.0.0

BREAKING CHANGE: Renamed values.global.supabase.url to values.global.supabase.publicUrl"
git push

# 4. Release via GitHub Actions UI
# 5. Update documentation with migration guide
```

## Support

For questions about versioning:
- Check this document
- Review [CONTRIBUTING.md](../CONTRIBUTING.md)
- Check workflow logs
- Open an issue with the `versioning` label
